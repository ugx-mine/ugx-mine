<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UGX Mining Platform</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- ✅ SUPABASE SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* Your exact CSS — unchanged */
.mining-card {
background: linear-gradient(135deg, #0f172a 0%, #121a2e 100%);
border: 1px solid #2a3d6a;
border-radius: 16px;
padding: 1.5rem;
margin-bottom: 1.5rem;
}
/* ... rest of your CSS ... */
</style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen font-sans">
<!-- Your entire HTML structure — 100% unchanged -->
<div class="container mx-auto px-4 py-6">
<!-- Header, Auth Card, Main Content, Admin Panel, Modals — ALL PRESERVED -->
<header class="flex justify-between items-center mb-8">
<!-- ... your header ... -->
</header>
<!-- ... rest of your HTML ... -->
</div>

<!-- ✅ UPGRADED SCRIPT — Supabase + Your Logic -->
<script>
// === SUPABASE INIT ===
const { createClient } = window.supabase;
const supabase = createClient(
  'https://rryvibgbpqyumfmgsiua.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyeXZpYmdicHF5dW1mbWdzaXVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4OTUwNTUsImV4cCI6MjA4MjQ3MTA1NX0.IMqZtMEiPyMwb8AW1gyFao9Yz2qWgMDibfbpVWOeG8o'
);

// === CONFIG (unchanged) ===
const ADMIN_USER = 'asutex2020';
const ADMIN_PASS = 'Asu12@ada24';

// === ⚡ UPGRADED: SUPABASE DATA LAYER ===
async function saveUser(username, userData) {
  // Convert appState-style keys to Supabase column names
  const dbUser = {
    username: username,
    password: userData.password,
    user_email: userData.userEmail || userData.user_email,
    balance: userData.balance || 0,
    mining_reward: userData.miningReward || userData.mining_reward || 10000,
    mining_cycle_hours: userData.miningCycleHours || userData.mining_cycle_hours || 24,
    next_claim_time: userData.nextClaimTime ? new Date(userData.nextClaimTime).toISOString() : null,
    pending_booster_tx_id: userData.pendingBoosterTxId || userData.pending_booster_tx_id || null,
    pending_booster: userData.pendingBooster || userData.pending_booster || null,
    user_wallet: userData.userWallet || userData.user_wallet || "",
    user_id: userData.userId || userData.user_id || `UGX-${Math.floor(100000 + Math.random() * 900000)}`,
    transactions: userData.transactions || [],
    last_withdrawal_approved: userData.lastWithdrawalApproved || null
  };
  const { error } = await supabase.from('users').upsert(dbUser, { onConflict: 'username' });
  if (error) console.error('Save error:', error);
}

async function getUser(username) {
  const { data, error } = await supabase.from('users').select('*').eq('username', username).single();
  if (error && error.code !== 'PGRST116') console.error('Fetch error:', error);
  if (!data) return null;

  // Convert DB columns back to appState format
  return {
    username: data.username,
    password: data.password,
    userEmail: data.user_email,
    balance: parseFloat(data.balance) || 0,
    miningReward: parseFloat(data.mining_reward) || 10000,
    miningCycleHours: parseFloat(data.mining_cycle_hours) || 24,
    nextClaimTime: data.next_claim_time ? new Date(data.next_claim_time).getTime() : 0,
    pendingBoosterTxId: data.pending_booster_tx_id,
    pendingBooster: data.pending_booster ? parseFloat(data.pending_booster) : null,
    userWallet: data.user_wallet,
    userId: data.user_id,
    transactions: Array.isArray(data.transactions) ? data.transactions : [],
    lastWithdrawalApproved: data.last_withdrawal_approved ? new Date(data.last_withdrawal_approved).getTime() : null
  };
}

async function getAllUsers() {
  const { data, error } = await supabase.from('users').select('*');
  if (error) {
    console.error('Fetch all users error:', error);
    return [];
  }
  return data.map(user => ({
    username: user.username,
    userEmail: user.user_email,
    balance: parseFloat(user.balance) || 0,
    miningCycleHours: parseFloat(user.mining_cycle_hours) || 24,
    userWallet: user.user_wallet,
    transactions: Array.isArray(user.transactions) ? user.transactions : []
  }));
}

// === YOUR ORIGINAL APP STATE & LOGIC ===
let appState = {
  isAuthenticated: false,
  currentUser: null,
  balance: 0,
  miningReward: 10000,
  miningCycleHours: 24,
  nextClaimTime: 0,
  pendingBoosterTxId: null,
  pendingBooster: null,
  transactions: [],
  userWallet: "",
  userEmail: "",
  userId: ""
};

// === YOUR ORIGINAL DOM ELEMENTS ===
const authCard = document.getElementById('authCard');
const authToggle = document.getElementById('authToggle');
// ... (all other DOM elements — same as your original file)

let balanceChart = null;
let txTypeChart = null;
let countdownInterval = null;

// === YOUR ORIGINAL FUNCTIONS — 100% PRESERVED ===
// (tab switching, signup, login, afterLogin, updateAuthButton, updateUI, formatUGX, toUSDT, startCountdown, claimReward, modals, admin panel, approveRequest, rejectRequest, etc.)

// Only difference: saveState() now uses Supabase
function saveState() {
  localStorage.setItem('ugx_current_user', appState.currentUser); // keep for auto-login
  if (appState.currentUser !== ADMIN_USER) {
    const user = {
      password: appState.password, // preserved from login
      userEmail: appState.userEmail,
      balance: appState.balance,
      miningReward: appState.miningReward,
      miningCycleHours: appState.miningCycleHours,
      nextClaimTime: appState.nextClaimTime,
      pendingBoosterTxId: appState.pendingBoosterTxId,
      pendingBooster: appState.pendingBooster,
      userWallet: appState.userWallet,
      userId: appState.userId,
      transactions: appState.transactions,
      lastWithdrawalApproved: appState.lastWithdrawalApproved
    };
    saveUser(appState.currentUser, user);
  }
}

// === INIT ===
async function initApp() {
  const savedUser = localStorage.getItem('ugx_current_user');
  if (savedUser) {
    const user = await getUser(savedUser);
    if (user) {
      // Reuse password for seamless login
      await login(savedUser, user.password);
      return;
    }
  }
  authCard.classList.remove('hidden');
  updateAuthButton();
}

// Attach your original event listeners here (same as your file)
// ...

// Load everything after DOM ready
document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
