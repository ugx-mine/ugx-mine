const SUPABASE_URL = 'https://rryvibgbpqyumfmgsiua.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyeXZpYmdicHF5dW1mbWdzaXVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4OTUwNTUsImV4cCI6MjA4MjQ3MTA1NX0.IMqZtMEiPyMwb8AW1gyFao9Yz2qWgMDibfbpVWOeG8o';
const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let user = null;
let timer;

// --- AUTH SECTION ---
document.getElementById('tabSignup').onclick = () => {
    document.getElementById('signupForm').classList.remove('hidden');
    document.getElementById('loginForm').classList.add('hidden');
    document.getElementById('tabSignup').classList.add('active');
    document.getElementById('tabLogin').classList.remove('active');
};

document.getElementById('tabLogin').onclick = () => {
    document.getElementById('loginForm').classList.remove('hidden');
    document.getElementById('signupForm').classList.add('hidden');
    document.getElementById('tabLogin').classList.add('active');
    document.getElementById('tabSignup').classList.remove('active');
};

document.getElementById('signupForm').onsubmit = async (e) => {
    e.preventDefault();
    const u = document.getElementById('signupUsername').value;
    const em = document.getElementById('signupEmail').value;
    const p = document.getElementById('signupPassword').value;
    
    const { error } = await _supabase.from('users').insert([{
        username: u, password: p, user_email: em, balance: 0, 
        mining_reward: 10000, mining_cycle_hours: 24, 
        next_claim_time: new Date().toISOString(),
        user_id: 'UGX' + Math.floor(Math.random()*1000000),
        withdrawal_status: 'none'
    }]);
    if (error) alert(error.message); else alert("Signup Success! Please Login.");
};

document.getElementById('loginForm').onsubmit = async (e) => {
    e.preventDefault();
    const u = document.getElementById('loginUsername').value;
    const p = document.getElementById('loginPassword').value;

    if (u === 'asutex2020' && p === 'Asu12@ada24') return loadAdmin();

    const { data, error } = await _supabase.from('users').select('*').eq('username', u).eq('password', p).maybeSingle();
    if (!data) return alert("Wrong credentials");
    user = data;
    loadDashboard();
};

// --- CORE DASHBOARD ---
function loadDashboard() {
    document.getElementById('authCard').classList.add('hidden');
    document.getElementById('mainContent').classList.remove('hidden');
    document.getElementById('profileUserName').textContent = user.username;
    document.getElementById('profileUserEmail').textContent = user.user_email;
    document.getElementById('profileUserId').textContent = "ID: " + user.user_id;
    updateUI();
    startTimer();
}

function updateUI() {
    const bal = user.balance || 0;
    document.getElementById('balanceUGX').textContent = bal.toLocaleString() + " UGX";
    document.getElementById('balanceUSDT').textContent = "~" + (bal/3700).toFixed(2) + " USDT";
    document.getElementById('miningCycleDisplay').textContent = (user.mining_cycle_hours || 24) + "h";

    const wBtn = document.getElementById('withdrawBtn');
    if (user.withdrawal_status === 'pending') {
        wBtn.textContent = "Withdrawal Pending...";
        wBtn.style.backgroundColor = "#4b5563"; // gray-600
        wBtn.disabled = true;
    } else {
        wBtn.textContent = "Request Withdrawal (Min: 50k)";
        wBtn.style.backgroundColor = "#d97706"; // amber-600
        wBtn.disabled = false;
    }
}

// --- MINING ENGINE ---
function startTimer() {
    if (timer) clearInterval(timer);
    const update = () => {
        const next = new Date(user.next_claim_time).getTime();
        const diff = next - Date.now();
        if (diff <= 0) {
            document.getElementById('miningCountdown').textContent = "Ready!";
            clearInterval(timer);
            return;
        }
        const h = Math.floor(diff/3600000).toString().padStart(2,'0');
        const m = Math.floor((diff%3600000)/60000).toString().padStart(2,'0');
        const s = Math.floor((diff%60000)/1000).toString().padStart(2,'0');
        document.getElementById('miningCountdown').textContent = `${h}:${m}:${s}`;
    };
    update();
    timer = setInterval(update, 1000);
}

document.getElementById('miningBtn').onclick = async () => {
    if (new Date(user.next_claim_time).getTime() > Date.now()) return alert("Still mining!");
    
    const newBal = (user.balance || 0) + 10000;
    const next = new Date(Date.now() + (user.mining_cycle_hours * 3600000)).toISOString();
    
    const { data, error } = await _supabase.from('users')
        .update({ balance: newBal, next_claim_time: next })
        .eq('username', user.username)
        .select().single();

    if (!error) {
        user = data;
        updateUI(); 
        startTimer();
    }
};

// --- WITHDRAWAL WORKFLOW ---
document.getElementById('editProfileBtn').onclick = () => document.getElementById('walletModal').classList.remove('hidden');

document.getElementById('saveWalletBtn').onclick = async () => {
    const w = document.getElementById('walletInput').value;
    const { error } = await _supabase.from('users').update({ user_wallet: w }).eq('username', user.username);
    if (!error) {
        user.user_wallet = w; 
        document.getElementById('walletModal').classList.add('hidden');
        alert("Wallet Saved!");
    }
};

document.getElementById('withdrawBtn').onclick = async () => {
    if (user.balance < 50000) return alert("Min 50,000 UGX required");
    if (!user.user_wallet) return alert("Set wallet first!");
    
    const { error } = await _supabase.from('users')
        .update({ withdrawal_status: 'pending' })
        .eq('username', user.username);

    if (!error) {
        user.withdrawal_status = 'pending';
        updateUI();
        alert("Request Sent! Admin will verify.");
    }
};

// --- ADMIN SYSTEM ---
async function loadAdmin() {
    document.getElementById('authCard').classList.add('hidden');
    document.getElementById('adminPanel').classList.remove('hidden');
    
    const { data } = await _supabase.from('users').select('*').order('username');
    
    document.getElementById('adminUserList').innerHTML = data.map(u => `
        <div class="p-4 bg-gray-800 rounded mb-3 border-l-4 ${u.withdrawal_status === 'pending' ? 'border-yellow-500' : 'border-gray-600'}">
            <div class="flex justify-between items-start">
                <div>
                    <p class="font-bold text-lg">${u.username}</p>
                    <p class="text-sm text-green-400 font-mono">${u.balance.toLocaleString()} UGX</p>
                    <p class="text-xs text-gray-400">Wallet: ${u.user_wallet || 'NOT SET'}</p>
                </div>
                <div class="flex flex-col gap-2">
                    ${u.withdrawal_status === 'pending' ? `
                        <button onclick="approveWithdrawal('${u.username}')" class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-xs">Approve & Reset</button>
                        <button onclick="rejectWithdrawal('${u.username}')" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-xs">Reject</button>
                    ` : `<span class="text-xs text-gray-500 uppercase font-bold">${u.withdrawal_status}</span>`}
                </div>
            </div>
        </div>
    `).join('');
}

window.approveWithdrawal = async (username) => {
    if (!confirm(`Are you sure you want to approve and RESET balance for ${username}?`)) return;
    const { error } = await _supabase.from('users').update({ balance: 0, withdrawal_status: 'approved' }).eq('username', username);
    if (error) alert(error.message); else loadAdmin();
};

window.rejectWithdrawal = async (username) => {
    if (!confirm(`Reject request for ${username}?`)) return;
    const { error } = await _supabase.from('users').update({ withdrawal_status: 'none' }).eq('username', username);
    if (error) alert(error.message); else loadAdmin();
};

window.activateBooster = async (h) => {
    const { error } = await _supabase.from('users').update({ mining_cycle_hours: h }).eq('username', user.username);
    if (!error) {
        user.mining_cycle_hours = h;
        updateUI(); 
        alert(h + "h Booster Activated!");
    }
};

document.getElementById('authToggle').onclick = () => location.reload();
window.onload = () => document.getElementById('authCard').classList.remove('hidden');
