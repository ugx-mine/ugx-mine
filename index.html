<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UGX Mining Platform</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.mining-card {
background: linear-gradient(135deg, #0f172a 0%, #121a2e 100%);
border: 1px solid #2a3d6a;
border-radius: 16px;
padding: 1.5rem;
margin-bottom: 1.5rem;
}
.booster-card {
background: linear-gradient(135deg, #1a2642 0%, #121a2e 100%);
border: 1px solid #2a3d6a;
border-radius: 16px;
padding: 1.5rem;
transition: all 0.3s ease;
position: relative;
overflow: hidden;
}
.booster-card::before {
content: '';
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 4px;
background: linear-gradient(90deg, #00c16a, #00a870);
}
.booster-card:hover {
transform: translateY(-5px);
box-shadow: 0 10px 25px rgba(0, 193, 106, 0.2);
border-color: #00c16a;
}
.booster-duration {
background: rgba(0, 193, 106, 0.15);
color: #00c16a;
border: 1px solid rgba(0, 193, 106, 0.3);
padding: 0.1rem 0.5rem;
border-radius: 4px;
font-size: 0.8rem;
font-weight: bold;
}
.countdown-display {
font-family: monospace;
font-size: 1.5rem;
background: rgba(18, 26, 46, 0.7);
padding: 0.5rem 1rem;
border-radius: 0.5rem;
min-width: 180px;
text-align: center;
}
.status-pending {
background-color: rgba(245, 158, 11, 0.15);
color: #f59e0b;
padding: 0.25rem 0.75rem;
border-radius: 9999px;
font-size: 0.75rem;
}
.no-transactions {
text-align: center;
padding: 2rem;
color: #64748b;
}
.currency-display {
font-family: 'Courier New', monospace;
font-weight: 600;
}
.edit-profile-btn {
background: transparent;
border: 1px solid #00c16a;
color: #00c16a;
padding: 0.25rem 0.75rem;
border-radius: 0.375rem;
font-size: 0.875rem;
display: flex;
align-items: center;
gap: 0.25rem;
transition: all 0.2s;
}
.edit-profile-btn:hover {
background: rgba(0, 193, 106, 0.1);
}
.action-buttons-section {
display: flex;
flex-wrap: wrap;
gap: 1rem;
margin-bottom: 2rem;
}
.action-button {
flex: 1;
min-width: 200px;
}
.auth-tab {
padding: 0.5rem 1rem;
cursor: pointer;
border-radius: 0.5rem;
}
.auth-tab.active {
background: rgba(0, 193, 106, 0.2);
color: #00c16a;
}
@keyframes slideIn {
from { transform: translateY(-20px); opacity: 0; }
to { transform: translateY(0); opacity: 1; }
}
#withdrawSuccessBanner {
animation: slideIn 0.3s ease-out;
}
@media (max-width: 768px) {
.action-buttons-section {
flex-direction: column;
}
.grid.grid-cols-1.md\:grid-cols-3 {
grid-template-columns: 1fr !important;
}
}
</style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen font-sans">
<div class="container mx-auto px-4 py-6">
<header class="flex justify-between items-center mb-8">
<div class="flex items-center space-x-3">
<div class="bg-green-500 p-2 rounded-lg">
<i class="fas fa-coins text-xl"></i>
</div>
<h1 class="text-2xl font-bold">UGX<span class="text-white">Mine</span></h1>
</div>
<div class="flex gap-2">
<button id="adminPanelBtn" class="px-3 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm hidden">
Admin Panel
</button>
<button id="authToggle" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg">
Sign Up / Login
</button>
</div>
</header>

<div id="authCard" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center hidden">
<div class="bg-gray-800 rounded-xl p-6 w-full max-w-md">
<div class="flex mb-4 bg-gray-700 rounded-lg p-1">
<div id="tabSignup" class="auth-tab active">Sign Up</div>
<div id="tabLogin" class="auth-tab">Login</div>
</div>
<form id="signupForm" class="hidden">
<div class="mb-4">
<label class="block text-gray-300 mb-2">Username</label>
<input type="text" id="signupUsername" class="w-full bg-gray-700 rounded-lg px-4 py-2" required>
</div>
<div class="mb-4">
<label class="block text-gray-300 mb-2">Email</label>
<input type="email" id="signupEmail" class="w-full bg-gray-700 rounded-lg px-4 py-2" required>
</div>
<div class="mb-4">
<label class="block text-gray-300 mb-2">Password</label>
<input type="password" id="signupPassword" class="w-full bg-gray-700 rounded-lg px-4 py-2" required>
</div>
<button type="submit" class="w-full bg-green-600 hover:bg-green-700 py-2 rounded-lg">
Create Account
</button>
</form>
<form id="loginForm">
<div class="mb-4">
<label class="block text-gray-300 mb-2">Username</label>
<input type="text" id="loginUsername" class="w-full bg-gray-700 rounded-lg px-4 py-2" required>
</div>
<div class="mb-4">
<label class="block text-gray-300 mb-2">Password</label>
<input type="password" id="loginPassword" class="w-full bg-gray-700 rounded-lg px-4 py-2" required>
</div>
<button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 py-2 rounded-lg">
Login
</button>
</form>
<button id="closeAuth" class="w-full mt-4 bg-gray-700 hover:bg-gray-600 py-2 rounded-lg">
Cancel
</button>
</div>
</div>

<main id="mainContent" class="hidden">
<div class="mining-card mb-6">
<div class="flex flex-wrap items-center justify-between gap-4">
<div class="flex items-center space-x-4">
<div class="w-12 h-12 rounded-full bg-emerald-900/30 flex items-center justify-center">
<i class="fas fa-user text-emerald-400"></i>
</div>
<div>
<div class="font-bold text-lg" id="profileUserName">JohnDoe</div>
<div class="text-gray-400 text-sm" id="profileUserEmail">johndoe@example.com</div>
<div class="text-gray-500 text-xs mt-1" id="profileUserId">User ID: UGX-789456</div>
</div>
</div>
<button id="editProfileBtn" class="edit-profile-btn">
<i class="fas fa-edit"></i> Wallet
</button>
</div>
</div>
<div id="withdrawSuccessBanner" class="mining-card bg-emerald-900/20 border-emerald-700 hidden mb-4">
<div class="flex items-center">
<i class="fas fa-check-circle text-emerald-400 mr-2"></i>
<span>✅ Withdrawal approved! Funds will be sent to your wallet.</span>
</div>
</div>
<div class="mining-card mb-6">
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
<div>
<p class="text-gray-400 text-sm">Current Balance</p>
<p class="text-3xl font-bold currency-display" id="balanceUGX">0 UGX</p>
<p class="text-gray-500 text-sm mt-1" id="balanceUSDT">(~0.00 USDT)</p>
</div>
<div>
<p class="text-gray-400 text-sm">Next Claim</p>
<p class="text-xl font-bold text-emerald-400" id="nextClaimAmount">10,000 UGX</p>
<p class="text-gray-500 text-xs mt-1">
<span id="claimCountdown">Ready!</span>
</p>
</div>
<div>
<p class="text-gray-400 text-sm">Mining Cycle</p>
<p class="text-xl font-bold" id="miningCycle">24 hours</p>
<p class="text-gray-500 text-xs" id="miningReward">10,000 UGX per cycle</p>
</div>
</div>
</div>
<div class="action-buttons-section">
<div class="action-button">
<div class="mining-card">
<h2 class="text-lg font-bold mb-2">Mining Control</h2>
<p class="text-gray-400 text-sm mb-4" id="miningDescription">Claim your first 10,000 UGX reward</p>
<div class="countdown-display" id="miningCountdown">Ready!</div>
<button id="miningBtn" class="w-full mt-4 bg-emerald-600 hover:bg-emerald-700 py-2 rounded-lg">
<i class="fas fa-coins mr-2"></i> Claim Rewards
</button>
</div>
</div>
<div class="action-button">
<div class="mining-card">
<h2 class="text-lg font-bold mb-2">Withdraw Funds</h2>
<p class="text-gray-400 text-sm mb-4">20% processing fee required</p>
<button id="withdrawBtn" class="w-full bg-amber-600 hover:bg-amber-700 py-2 rounded-lg">
<i class="fas fa-wallet mr-2"></i> Request Withdrawal
</button>
</div>
</div>
</div>
<div class="mb-8">
<h2 class="text-xl font-bold mb-4">Mining Boosters</h2>
<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
<div class="booster-card">
<div class="flex justify-between items-start mb-3">
<h3 class="font-bold text-lg text-green-400">Speed Booster</h3>
<span class="booster-duration">8 HOURS</span>
</div>
<p class="text-gray-400 text-sm mb-4">Earn 10,000 UGX every 8 hours</p>
<div class="flex justify-between items-center">
<div>
<p class="text-gray-300 text-sm">Cost: 2x Balance</p>
<p class="font-bold currency-display mt-1" id="booster1CostUGX">0 UGX</p>
<p class="text-gray-500 text-xs" id="booster1CostUSDT">(~0.00 USDT)</p>
</div>
<button id="buyBooster1" class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-sm">
Activate
</button>
</div>
</div>
<div class="booster-card">
<div class="flex justify-between items-start mb-3">
<h3 class="font-bold text-lg text-blue-400">Power Booster</h3>
<span class="booster-duration">6 HOURS</span>
</div>
<p class="text-gray-400 text-sm mb-4">Earn 10,000 UGX every 6 hours</p>
<div class="flex justify-between items-center">
<div>
<p class="text-gray-300 text-sm">Cost: 4x Balance</p>
<p class="font-bold currency-display mt-1" id="booster2CostUGX">0 UGX</p>
<p class="text-gray-500 text-xs" id="booster2CostUSDT">(~0.00 USDT)</p>
</div>
<button id="buyBooster2" class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-sm">
Activate
</button>
</div>
</div>
<div class="booster-card">
<div class="flex justify-between items-start mb-3">
<h3 class="font-bold text-lg text-purple-400">Quantum Booster</h3>
<span class="booster-duration">4 HOURS</span>
</div>
<p class="text-gray-400 text-sm mb-4">Earn 10,000 UGX every 4 hours</p>
<div class="flex justify-between items-center">
<div>
<p class="text-gray-300 text-sm">Cost: 8x Balance</p>
<p class="font-bold currency-display mt-1" id="booster3CostUGX">0 UGX</p>
<p class="text-gray-500 text-xs" id="booster3CostUSDT">(~0.00 USDT)</p>
</div>
<button id="buyBooster3" class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-sm">
Activate
</button>
</div>
</div>
</div>
</div>
<div class="mining-card">
<h2 class="text-xl font-bold mb-4">Transaction History</h2>
<div id="transactionList">
<div class="no-transactions">No transactions yet</div>
</div>
</div>
</main>

<div id="adminPanel" class="hidden">
<button id="backToMain" class="mb-4 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg flex items-center gap-1">
<i class="fas fa-arrow-left"></i> Back to Dashboard
</button>
<h2 class="text-2xl font-bold mb-6 text-emerald-400">Admin Dashboard</h2>
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
<div class="mining-card bg-gradient-to-r from-blue-900/50 to-blue-800/30 border-blue-700">
<p class="text-gray-400">Total Users</p>
<p class="text-2xl font-bold" id="adminTotalUsers">0</p>
</div>
<div class="mining-card bg-gradient-to-r from-emerald-900/50 to-emerald-800/30 border-emerald-700">
<p class="text-gray-400">Total Balance</p>
<p class="text-2xl font-bold" id="adminTotalBalance">0 UGX</p>
</div>
<div class="mining-card bg-gradient-to-r from-amber-900/50 to-amber-800/30 border-amber-700">
<p class="text-gray-400">Pending Requests</p>
<p class="text-2xl font-bold" id="adminPendingRequests">0</p>
</div>
<div class="mining-card bg-gradient-to-r from-purple-900/50 to-purple-800/30 border-purple-700">
<p class="text-gray-400">Active Boosters</p>
<p class="text-2xl font-bold" id="adminActiveBoosters">0</p>
</div>
</div>
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
<div class="mining-card">
<h3 class="font-bold mb-4">User Balance Distribution</h3>
<canvas id="balanceChart" height="200"></canvas>
</div>
<div class="mining-card">
<h3 class="font-bold mb-4">Transaction Types</h3>
<canvas id="txTypeChart" height="200"></canvas>
</div>
</div>
<div class="mining-card">
<div class="flex flex-wrap justify-between items-center mb-4">
<h3 class="font-bold">All Transactions</h3>
<div class="flex gap-2 mt-2 md:mt-0">
<input type="text" id="adminSearch" placeholder="Search user or TXID..." class="bg-gray-700 rounded-lg px-3 py-1 text-sm">
<select id="adminFilter" class="bg-gray-700 rounded-lg px-3 py-1 text-sm">
<option value="all">All Types</option>
<option value="Booster Payment">Booster Payments</option>
<option value="Withdrawal Request">Withdrawals</option>
</select>
</div>
</div>
<div class="overflow-x-auto">
<table class="w-full text-sm">
<thead>
<tr class="border-b border-gray-700">
<th class="text-left py-2">User</th>
<th class="text-left py-2">Wallet</th>
<th class="text-left py-2">Type</th>
<th class="text-left py-2">Amount</th>
<th class="text-left py-2">Status</th>
<th class="text-left py-2">Date</th>
<th class="text-left py-2">Actions</th>
</tr>
</thead>
<tbody id="adminTxTableBody">
<tr>
<td colspan="7" class="text-center py-4 text-gray-500">Loading transactions...</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="mining-card mt-6">
<h3 class="font-bold mb-4">User List</h3>
<div class="overflow-x-auto">
<table class="w-full text-sm">
<thead>
<tr class="border-b border-gray-700">
<th class="text-left py-2">Username</th>
<th class="text-left py-2">Email</th>
<th class="text-left py-2">Balance</th>
<th class="text-left py-2">Wallet</th>
<th class="text-left py-2">Cycle</th>
</tr>
</thead>
<tbody id="adminUserTableBody">
<tr>
<td colspan="5" class="text-center py-4 text-gray-500">Loading users...</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<!-- Modals -->
<div id="withdrawModal" class="fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4 hidden">
<div class="bg-gray-800 rounded-2xl p-6 w-full max-w-md">
<div class="flex justify-between items-center mb-6">
<h2 class="text-2xl font-bold">Withdraw Funds</h2>
<button id="closeWithdraw" class="text-gray-400">
<i class="fas fa-times"></i>
</button>
</div>
<div class="mb-5">
<p class="text-gray-300 mb-2">You will receive your full balance:</p>
<p class="text-xl font-bold currency-display" id="withdrawAmountUGX">0 UGX</p>
<p class="text-gray-400 text-sm mb-4" id="withdrawAmountUSDT">(~0.00 USDT)</p>
<p class="text-gray-300 mb-2">Processing fee (20% — paid separately):</p>
<p class="text-lg text-amber-400 font-bold" id="withdrawFeeUGX">0 UGX</p>
<p class="text-gray-500 text-sm mb-4" id="withdrawFeeUSDT">(~0.00 USDT)</p>
<div id="userWalletSection" class="mb-4 p-3 bg-gray-700/50 rounded-lg hidden">
<p class="text-gray-300 text-sm">Withdrawal destination:</p>
<p class="font-mono text-sm break-all" id="displayUserWallet">T...</p>
<p class="text-gray-500 text-xs mt-1">Funds will be sent here after approval</p>
</div>
<p class="mt-2 mb-3">Send the fee to admin wallet:</p>
<div class="bg-gray-700 p-3 rounded-xl break-all flex items-center justify-between">
<p class="font-mono text-sm" id="adminWallet">TX3CWq6CPLpJdPeSsEDdY5vjGyYF5f1Csg</p>
<button id="copyWallet" class="bg-amber-600 hover:bg-amber-700 text-xs px-2 py-1 rounded">
Copy
</button>
</div>
<p class="text-gray-500 text-xs mt-2">USDT (TRC20) or UGX tokens accepted</p>
</div>
<div>
<label class="block text-gray-300 mb-2">Transaction ID (for fee payment)</label>
<input type="text" id="withdrawTxId" class="w-full bg-gray-700 rounded-lg px-4 py-2" placeholder="Enter transaction ID">
<p class="text-gray-500 text-xs mt-1">Admin will approve your withdrawal after fee confirmation</p>
</div>
<div class="flex gap-3 mt-6">
<button id="confirmWithdraw" class="flex-1 bg-green-600 hover:bg-green-700 py-2 rounded-lg">Submit Request</button>
<button id="cancelWithdraw" class="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded-lg">Cancel</button>
</div>
</div>
</div>

<div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4 hidden">
<div class="bg-gray-800 rounded-2xl p-6 w-full max-w-md">
<div class="flex justify-between items-center mb-6">
<h2 class="text-2xl font-bold" id="paymentTitle">Booster Payment</h2>
<button id="closePayment" class="text-gray-400">
<i class="fas fa-times"></i>
</button>
</div>
<div class="mb-4 p-3 bg-gray-700 rounded-lg">
<p class="text-gray-300 text-sm">Currently mining:</p>
<p class="font-bold" id="currentMiningInfo">24 hours → 10,000 UGX/cycle</p>
</div>
<div class="mb-4 p-3 bg-emerald-900/30 border border-emerald-700 rounded-lg">
<p class="text-gray-300 text-sm">After activation:</p>
<p class="font-bold text-emerald-400" id="newMiningInfo">8 hours → 10,000 UGX/cycle</p>
</div>
<div class="mb-5">
<p class="mb-3">Send payment to admin wallet:</p>
<div class="bg-gray-700 p-3 rounded-xl break-all flex items-center justify-between">
<p class="font-mono text-sm" id="paymentWalletAddress">TX3CWq6CPLpJdPeSsEDdY5vjGyYF5f1Csg</p>
<button id="copyBoosterWallet" class="bg-emerald-600 hover:bg-emerald-700 text-xs px-2 py-1 rounded">
Copy
</button>
</div>
<p class="text-gray-500 text-xs mt-2">USDT (TRC20) or UGX tokens accepted</p>
</div>
<div>
<label class="block text-gray-300 mb-2">Transaction ID</label>
<input type="text" id="transactionId" class="w-full bg-gray-700 rounded-lg px-4 py-2" placeholder="Enter transaction ID">
<p class="text-gray-500 text-xs mt-1">Admin will approve your booster after payment confirmation</p>
</div>
<div class="flex gap-3 mt-6">
<button id="confirmPayment" class="flex-1 bg-green-600 hover:bg-green-700 py-2 rounded-lg">Submit Payment</button>
<button id="cancelPayment" class="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded-lg">Cancel</button>
</div>
</div>
</div>

<div id="editProfileModal" class="fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4 hidden">
<div class="bg-gray-800 rounded-2xl p-6 w-full max-w-md">
<div class="flex justify-between items-center mb-6">
<h2 class="text-2xl font-bold">Edit Profile</h2>
<button id="closeEditProfile" class="text-gray-400">
<i class="fas fa-times"></i>
</button>
</div>
<div class="mb-4">
<label class="block text-gray-300 mb-2">Withdrawal Wallet Address (USDT TRC20 or UGX)</label>
<input type="text" id="userWalletInput" class="w-full bg-gray-700 rounded-lg px-4 py-2" placeholder="Enter wallet address">
<p class="text-gray-500 text-xs mt-1">Funds will be sent to this address after withdrawal approval</p>
</div>
<div class="flex gap-3">
<button id="saveProfile" class="flex-1 bg-green-600 hover:bg-green-700 py-2 rounded-lg">Save</button>
<button id="cancelEditProfile" class="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded-lg">Cancel</button>
</div>
</div>
</div>

<div id="receiptModal" class="fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4 hidden">
<div class="bg-gray-800 rounded-2xl p-6 w-full max-w-md">
<div class="flex justify-between items-center mb-6">
<h2 class="text-2xl font-bold">Transaction Receipt</h2>
<button id="closeReceipt" class="text-gray-400">
<i class="fas fa-times"></i>
</button>
</div>
<div id="receiptContent" class="bg-gray-900 p-4 rounded-lg font-mono text-sm whitespace-pre-wrap break-all">
Loading receipt...
</div>
<div class="flex gap-3 mt-6">
<button id="copyReceipt" class="flex-1 bg-emerald-600 hover:bg-emerald-700 py-2 rounded-lg">
<i class="fas fa-copy mr-2"></i> Copy
</button>
<button id="printReceipt" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2 rounded-lg">
<i class="fas fa-print mr-2"></i> Print
</button>
</div>
</div>
</div>

<!-- ✅ FULL SCRIPT — ALL INSIDE DOMContentLoaded -->
<script>
document.addEventListener('DOMContentLoaded', () => {
// === CONFIG ===
const ADMIN_USER = 'asutex2020';
const ADMIN_PASS = 'Asu12@ada24';

// === USER STORAGE ===
function saveUser(username, userData) {
  const users = JSON.parse(localStorage.getItem('ugx_users') || '{}');
  users[username] = userData;
  localStorage.setItem('ugx_users', JSON.stringify(users));
}
function getUser(username) {
  const users = JSON.parse(localStorage.getItem('ugx_users') || '{}');
  return users[username] || null;
}
function getAllUsers() {
  const users = JSON.parse(localStorage.getItem('ugx_users') || '{}');
  return Object.entries(users).map(([username, data]) => ({ username, ...data }));
}
function getAllTransactions() {
  const users = getAllUsers();
  let allTx = [];
  users.forEach(user => {
    (user.transactions || []).forEach(tx => {
      allTx.push({ ...tx, username: user.username });
    });
  });
  return allTx;
}
function getAllPendingTransactions() {
  return getAllTransactions().filter(tx => tx.status === 'pending');
}

// === APP STATE ===
let appState = {
  isAuthenticated: false,
  currentUser: null,
  balance: 0,
  miningReward: 10000,
  miningCycleHours: 24,
  nextClaimTime: 0,
  pendingBoosterTxId: null,
  pendingBooster: null,
  transactions: [],
  userWallet: "",
  userEmail: "",
  userId: ""
};

// === DOM ELEMENTS ===
const authCard = document.getElementById('authCard');
const authToggle = document.getElementById('authToggle');
const adminPanelBtn = document.getElementById('adminPanelBtn');
const closeAuth = document.getElementById('closeAuth');
const signupForm = document.getElementById('signupForm');
const loginForm = document.getElementById('loginForm');
const tabSignup = document.getElementById('tabSignup');
const tabLogin = document.getElementById('tabLogin');
const mainContent = document.getElementById('mainContent');
const adminPanel = document.getElementById('adminPanel');
const backToMain = document.getElementById('backToMain');
const profileUserId = document.getElementById('profileUserId');
const profileUserName = document.getElementById('profileUserName');
const profileUserEmail = document.getElementById('profileUserEmail');
const editProfileBtn = document.getElementById('editProfileBtn');
const miningBtn = document.getElementById('miningBtn');
const miningDescription = document.getElementById('miningDescription');
const miningCountdown = document.getElementById('miningCountdown');
const withdrawBtn = document.getElementById('withdrawBtn');
const balanceUGX = document.getElementById('balanceUGX');
const balanceUSDT = document.getElementById('balanceUSDT');
const nextClaimAmount = document.getElementById('nextClaimAmount');
const claimCountdown = document.getElementById('claimCountdown');
const miningCycle = document.getElementById('miningCycle');
const miningRewardEl = document.getElementById('miningReward');
const transactionList = document.getElementById('transactionList');
const withdrawSuccessBanner = document.getElementById('withdrawSuccessBanner');
const withdrawModal = document.getElementById('withdrawModal');
const closeWithdraw = document.getElementById('closeWithdraw');
const copyWallet = document.getElementById('copyWallet');
const withdrawTxId = document.getElementById('withdrawTxId');
const confirmWithdraw = document.getElementById('confirmWithdraw');
const cancelWithdraw = document.getElementById('cancelWithdraw');
const withdrawAmountUGX = document.getElementById('withdrawAmountUGX');
const withdrawAmountUSDT = document.getElementById('withdrawAmountUSDT');
const withdrawFeeUGX = document.getElementById('withdrawFeeUGX');
const withdrawFeeUSDT = document.getElementById('withdrawFeeUSDT');
const userWalletSection = document.getElementById('userWalletSection');
const displayUserWallet = document.getElementById('displayUserWallet');
const paymentModal = document.getElementById('paymentModal');
const paymentTitle = document.getElementById('paymentTitle');
const closePayment = document.getElementById('closePayment');
const paymentWalletAddress = document.getElementById('paymentWalletAddress');
const transactionId = document.getElementById('transactionId');
const confirmPayment = document.getElementById('confirmPayment');
const cancelPayment = document.getElementById('cancelPayment');
const buyBooster1 = document.getElementById('buyBooster1');
const buyBooster2 = document.getElementById('buyBooster2');
const buyBooster3 = document.getElementById('buyBooster3');
const booster1CostUGX = document.getElementById('booster1CostUGX');
const booster1CostUSDT = document.getElementById('booster1CostUSDT');
const booster2CostUGX = document.getElementById('booster2CostUGX');
const booster2CostUSDT = document.getElementById('booster2CostUSDT');
const booster3CostUGX = document.getElementById('booster3CostUGX');
const booster3CostUSDT = document.getElementById('booster3CostUSDT');
const currentMiningInfo = document.getElementById('currentMiningInfo');
const newMiningInfo = document.getElementById('newMiningInfo');
const copyBoosterWallet = document.getElementById('copyBoosterWallet');
const editProfileModal = document.getElementById('editProfileModal');
const closeEditProfile = document.getElementById('closeEditProfile');
const userWalletInput = document.getElementById('userWalletInput');
const saveProfile = document.getElementById('saveProfile');
const cancelEditProfile = document.getElementById('cancelEditProfile');
const adminTotalUsers = document.getElementById('adminTotalUsers');
const adminTotalBalance = document.getElementById('adminTotalBalance');
const adminPendingRequests = document.getElementById('adminPendingRequests');
const adminActiveBoosters = document.getElementById('adminActiveBoosters');
const adminSearch = document.getElementById('adminSearch');
const adminFilter = document.getElementById('adminFilter');
const adminTxTableBody = document.getElementById('adminTxTableBody');
const adminUserTableBody = document.getElementById('adminUserTableBody');
const receiptModal = document.getElementById('receiptModal');
const closeReceipt = document.getElementById('closeReceipt');
const copyReceipt = document.getElementById('copyReceipt');
const printReceipt = document.getElementById('printReceipt');
const receiptContent = document.getElementById('receiptContent');

let balanceChart = null;
let txTypeChart = null;
let countdownInterval = null;

// === AUTH TABS ===
tabSignup.addEventListener('click', () => {
  tabSignup.classList.add('active');
  tabLogin.classList.remove('active');
  signupForm.classList.remove('hidden');
  loginForm.classList.add('hidden');
});
tabLogin.addEventListener('click', () => {
  tabLogin.classList.add('active');
  tabSignup.classList.remove('active');
  loginForm.classList.remove('hidden');
  signupForm.classList.add('hidden');
});

// === SIGN UP ===
signupForm.addEventListener('submit', (e) => {
  e.preventDefault();
  const username = document.getElementById('signupUsername').value.trim();
  const email = document.getElementById('signupEmail').value.trim();
  const password = document.getElementById('signupPassword').value;
  if (!username || !email || !password) {
    alert('All fields required');
    return;
  }
  if (getUser(username)) {
    alert('Username already exists');
    return;
  }
  const newUser = {
    username,
    userEmail: email,
    password,
    balance: 0,
    miningReward: 10000,
    miningCycleHours: 24,
    nextClaimTime: 0,
    pendingBoosterTxId: null,
    pendingBooster: null,
    transactions: [],
    userWallet: "",
    userId: `UGX-${Math.floor(100000 + Math.random() * 900000)}`
  };
  saveUser(username, newUser);
  login(username, password);
});

// === LOGIN ===
loginForm.addEventListener('submit', (e) => {
  e.preventDefault();
  const username = document.getElementById('loginUsername').value.trim();
  const password = document.getElementById('loginPassword').value;
  login(username, password);
});

function login(username, password) {
  if (username === ADMIN_USER && password === ADMIN_PASS) {
    appState = {
      isAuthenticated: true,
      currentUser: ADMIN_USER,
      balance: 0,
      miningReward: 10000,
      miningCycleHours: 24,
      nextClaimTime: 0,
      pendingBoosterTxId: null,
      pendingBooster: null,
      transactions: [],
      userWallet: "",
      userEmail: "admin@ugxmine.com",
      userId: "ADMIN"
    };
    afterLogin();
    return true;
  }
  const user = getUser(username);
  if (!user) {
    alert('User not found');
    return false;
  }
  if (user.password !== password) {
    alert('Incorrect password');
    return false;
  }
  appState = {
    isAuthenticated: true,
    currentUser: username,
    balance: user.balance || 0,
    miningReward: user.miningReward || 10000,
    miningCycleHours: user.miningCycleHours || 24,
    nextClaimTime: user.nextClaimTime || 0,
    pendingBoosterTxId: user.pendingBoosterTxId || null,
    pendingBooster: user.pendingBooster || null,
    transactions: user.transactions || [],
    userWallet: user.userWallet || "",
    userEmail: user.userEmail || "",
    userId: user.userId || `UGX-${Math.floor(100000 + Math.random() * 900000)}`
  };
  if (user.lastWithdrawalApproved && (Date.now() - user.lastWithdrawalApproved < 60000)) {
    setTimeout(() => {
      if (withdrawSuccessBanner) {
        withdrawSuccessBanner.classList.remove('hidden');
        setTimeout(() => withdrawSuccessBanner.classList.add('hidden'), 5000);
      }
    }, 500);
    user.lastWithdrawalApproved = null;
    saveUser(username, user);
  }
  afterLogin();
  return true;
}

function afterLogin() {
  authCard.classList.add('hidden');
  mainContent.classList.remove('hidden');
  localStorage.setItem('ugx_current_user', appState.currentUser);
  updateAuthButton();
  adminPanelBtn.classList.toggle('hidden', appState.currentUser !== ADMIN_USER);
  updateUI();
  if (appState.nextClaimTime > 0 && Date.now() < appState.nextClaimTime) {
    startCountdown();
  }
}

function updateAuthButton() {
  if (appState.isAuthenticated) {
    authToggle.textContent = 'Logout';
    authToggle.className = 'px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg';
  } else {
    authToggle.textContent = 'Sign Up / Login';
    authToggle.className = 'px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg';
  }
}

// === ✅ THE FIX: AUTH TOGGLE LISTENER INSIDE DOMContentLoaded ===
authToggle.addEventListener('click', () => {
  if (appState.isAuthenticated) {
    appState.isAuthenticated = false;
    appState.currentUser = null;
    localStorage.removeItem('ugx_current_user');
    mainContent.classList.add('hidden');
    adminPanel.classList.add('hidden');
    authCard.classList.add('hidden');
    updateAuthButton();
  } else {
    authCard.classList.remove('hidden');
  }
});

// === CLOSE BUTTONS ===
closeAuth.addEventListener('click', () => authCard.classList.add('hidden'));
closeWithdraw.addEventListener('click', () => withdrawModal.classList.add('hidden'));
closePayment.addEventListener('click', () => paymentModal.classList.add('hidden'));
closeEditProfile.addEventListener('click', () => editProfileModal.classList.add('hidden'));
closeReceipt.addEventListener('click', () => receiptModal.classList.add('hidden'));
cancelWithdraw.addEventListener('click', () => withdrawModal.classList.add('hidden'));
cancelPayment.addEventListener('click', () => paymentModal.classList.add('hidden'));
cancelEditProfile.addEventListener('click', () => editProfileModal.classList.add('hidden'));
backToMain.addEventListener('click', () => {
  adminPanel.classList.add('hidden');
  mainContent.classList.remove('hidden');
});

// === EDIT PROFILE ===
editProfileBtn.addEventListener('click', () => {
  userWalletInput.value = appState.userWallet;
  editProfileModal.classList.remove('hidden');
});
saveProfile.addEventListener('click', () => {
  appState.userWallet = userWalletInput.value.trim();
  if (appState.currentUser !== ADMIN_USER) {
    const user = getUser(appState.currentUser);
    user.userWallet = appState.userWallet;
    saveUser(appState.currentUser, user);
  }
  updateUI();
  editProfileModal.classList.add('hidden');
});

// === WITHDRAW MODAL ===
withdrawBtn.addEventListener('click', () => {
  if (appState.balance <= 0) {
    alert('No balance to withdraw');
    return;
  }
  withdrawAmountUGX.textContent = `${appState.balance.toLocaleString()} UGX`;
  const usdtAmount = toUSDT(appState.balance);
  withdrawAmountUSDT.textContent = `(~${usdtAmount.toFixed(2)} USDT)`;
  const fee = Math.floor(appState.balance * 0.2);
  withdrawFeeUGX.textContent = `${fee.toLocaleString()} UGX`;
  withdrawFeeUSDT.textContent = `(~${toUSDT(fee).toFixed(2)} USDT)`;
  if (appState.userWallet) {
    userWalletSection.classList.remove('hidden');
    displayUserWallet.textContent = appState.userWallet;
  } else {
    userWalletSection.classList.add('hidden');
  }
  withdrawTxId.value = '';
  withdrawModal.classList.remove('hidden');
});
confirmWithdraw.addEventListener('click', () => {
  const txId = withdrawTxId.value.trim();
  if (!txId) {
    alert('Please enter a transaction ID for the fee payment.');
    return;
  }
  const fee = Math.floor(appState.balance * 0.2);
  appState.transactions.push({
    id: 'TXN-' + Date.now(),
    type: 'Withdrawal Request',
    description: `Fee payment TxID: ${txId}. Full balance: ${formatUGX(appState.balance)} UGX`,
    amount: appState.balance,
    fee: fee,
    status: 'pending',
    timestamp: Date.now(),
    wallet: appState.userWallet
  });
  if (appState.currentUser !== ADMIN_USER) {
    const user = getUser(appState.currentUser);
    user.transactions = appState.transactions;
    saveUser(appState.currentUser, user);
  }
  updateUI();
  withdrawModal.classList.add('hidden');
  alert('Withdrawal request submitted for admin approval!');
});

// === BOOSTER PAYMENTS ===
function showPaymentModal(boosterHours, costMultiplier) {
  paymentTitle.textContent = 'Booster Payment';
  currentMiningInfo.textContent = `${appState.miningCycleHours} hours → ${formatUGX(appState.miningReward)} UGX/cycle`;
  newMiningInfo.textContent = `${boosterHours} hours → ${formatUGX(appState.miningReward)} UGX/cycle`;
  transactionId.value = '';
  paymentModal.classList.remove('hidden');
  paymentModal.dataset.boosterHours = boosterHours;
  paymentModal.dataset.costMultiplier = costMultiplier;
}
buyBooster1.addEventListener('click', () => showPaymentModal(8, 2));
buyBooster2.addEventListener('click', () => showPaymentModal(6, 4));
buyBooster3.addEventListener('click', () => showPaymentModal(4, 8));
confirmPayment.addEventListener('click', () => {
  const txId = transactionId.value.trim();
  if (!txId) {
    alert('Please enter a transaction ID.');
    return;
  }
  const boosterHours = parseInt(paymentModal.dataset.boosterHours);
  const costMultiplier = parseInt(paymentModal.dataset.costMultiplier);
  const cost = appState.balance * costMultiplier;
  appState.transactions.push({
    id: 'TXN-' + Date.now(),
    type: 'Booster Payment',
    description: `Payment for ${boosterHours}-hour booster. Cost: ${formatUGX(cost)} UGX`,
    amount: cost,
    status: 'pending',
    timestamp: Date.now(),
    boosterHours: boosterHours
  });
  appState.pendingBoosterTxId = appState.transactions[appState.transactions.length - 1].id;
  appState.pendingBooster = boosterHours;
  if (appState.currentUser !== ADMIN_USER) {
    const user = getUser(appState.currentUser);
    user.transactions = appState.transactions;
    user.pendingBoosterTxId = appState.pendingBoosterTxId;
    user.pendingBooster = appState.pendingBooster;
    saveUser(appState.currentUser, user);
  }
  updateUI();
  paymentModal.classList.add('hidden');
  alert('Booster payment submitted for admin approval!');
});

// === MINING ===
miningBtn.addEventListener('click', claimReward);
function claimReward() {
  appState.balance += appState.miningReward;
  if (appState.pendingBoosterTxId) {
    const tx = appState.transactions.find(t => t.id === appState.pendingBoosterTxId);
    if (tx && tx.status === 'approved') {
      appState.miningCycleHours = appState.pendingBooster;
      appState.pendingBooster = null;
      appState.pendingBoosterTxId = null;
    }
  }
  const cycleMs = appState.miningCycleHours * 60 * 60 * 1000;
  appState.nextClaimTime = Date.now() + cycleMs;
  if (appState.currentUser !== ADMIN_USER) {
    const user = getUser(appState.currentUser);
    user.balance = appState.balance;
    user.miningCycleHours = appState.miningCycleHours;
    user.nextClaimTime = appState.nextClaimTime;
    user.pendingBoosterTxId = appState.pendingBoosterTxId;
    user.pendingBooster = appState.pendingBooster;
    saveUser(appState.currentUser, user);
  }
  updateUI();
  startCountdown();
  alert(`Claimed ${formatUGX(appState.miningReward)} UGX!`);
}

// === COUNTDOWN ===
function startCountdown() {
  clearInterval(countdownInterval);
  countdownInterval = setInterval(() => {
    const now = Date.now();
    if (now >= appState.nextClaimTime) {
      clearInterval(countdownInterval);
      miningCountdown.textContent = 'Ready!';
      miningBtn.disabled = false;
      miningBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      return;
    }
    const diff = appState.nextClaimTime - now;
    const hrs = Math.floor(diff / (1000 * 60 * 60));
    const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const secs = Math.floor((diff % (1000 * 60)) / 1000);
    miningCountdown.textContent = `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    miningBtn.disabled = true;
    miningBtn.classList.add('opacity-50', 'cursor-not-allowed');
  }, 1000);
}

// === UI UPDATE ===
function updateUI() {
  profileUserName.textContent = appState.currentUser;
  profileUserEmail.textContent = appState.userEmail;
  profileUserId.textContent = `User ID: ${appState.userId}`;
  balanceUGX.textContent = `${formatUGX(appState.balance)} UGX`;
  balanceUSDT.textContent = `(~${toUSDT(appState.balance).toFixed(2)} USDT)`;
  nextClaimAmount.textContent = `${formatUGX(appState.miningReward)} UGX`;
  miningCycle.textContent = `${appState.miningCycleHours} hours`;
  miningRewardEl.textContent = `${formatUGX(appState.miningReward)} UGX per cycle`;
  miningDescription.textContent = appState.nextClaimTime > Date.now() 
    ? `Next reward ready in ${Math.ceil((appState.nextClaimTime - Date.now()) / (1000 * 60 * 60))} hours`
    : 'Claim your reward now!';
  booster1CostUGX.textContent = `${formatUGX(appState.balance * 2)} UGX`;
  booster1CostUSDT.textContent = `(~${toUSDT(appState.balance * 2).toFixed(2)} USDT)`;
  booster2CostUGX.textContent = `${formatUGX(appState.balance * 4)} UGX`;
  booster2CostUSDT.textContent = `(~${toUSDT(appState.balance * 4).toFixed(2)} USDT)`;
  booster3CostUGX.textContent = `${formatUGX(appState.balance * 8)} UGX`;
  booster3CostUSDT.textContent = `(~${toUSDT(appState.balance * 8).toFixed(2)} USDT)`;
  renderTransactions();
  if (appState.nextClaimTime > Date.now()) {
    startCountdown();
  } else {
    miningCountdown.textContent = 'Ready!';
    miningBtn.disabled = false;
    miningBtn.classList.remove('opacity-50', 'cursor-not-allowed');
  }
}
function renderTransactions() {
  if (appState.transactions.length === 0) {
    transactionList.innerHTML = '<div class="no-transactions">No transactions yet</div>';
    return;
  }
  transactionList.innerHTML = appState.transactions.map(tx => `
    <div class="mining-card p-3 mb-2">
      <div class="flex justify-between">
        <div>
          <span class="font-bold">${tx.type}</span>
          <p class="text-gray-400 text-sm mt-1">${tx.description}</p>
        </div>
        <div class="text-right">
          <div class="font-bold currency-display">${tx.amount ? formatUGX(tx.amount) + ' UGX' : ''}</div>
          <span class="status-pending mt-1">${tx.status}</span>
        </div>
      </div>
      <div class="text-gray-500 text-xs mt-2">${new Date(tx.timestamp).toLocaleString()}</div>
      ${tx.id ? `<button onclick="showReceipt('${tx.id}')" class="text-emerald-400 text-xs mt-2">View Receipt</button>` : ''}
    </div>
  `).join('');
  window.showReceipt = (txId) => {
    const tx = appState.transactions.find(t => t.id === txId);
    if (!tx) return;
    receiptContent.textContent = 
`Transaction Receipt
====================
Type: ${tx.type}
Amount: ${tx.amount ? formatUGX(tx.amount) + ' UGX' : 'N/A'}
Status: ${tx.status}
Date: ${new Date(tx.timestamp).toLocaleString()}
Description: ${tx.description}
User: ${appState.currentUser}
Wallet: ${appState.userWallet || 'Not set'}
`;
    receiptModal.classList.remove('hidden');
  };
}
function formatUGX(amount) {
  return Math.floor(amount).toLocaleString();
}
function toUSDT(ugx) {
  return ugx / 4000;
}

// === ADMIN PANEL ===
adminPanelBtn.addEventListener('click', () => {
  mainContent.classList.add('hidden');
  adminPanel.classList.remove('hidden');
  loadAdminPanel();
});
copyWallet.addEventListener('click', () => {
  navigator.clipboard.writeText('TX3CWq6CPLpJdPeSsEDdY5vjGyYF5f1Csg').then(() => {
    const btn = copyWallet;
    const original = btn.innerHTML;
    btn.innerHTML = 'Copied!';
    setTimeout(() => btn.innerHTML = original, 2000);
  });
});
copyBoosterWallet.addEventListener('click', () => {
  navigator.clipboard.writeText('TX3CWq6CPLpJdPeSsEDdY5vjGyYF5f1Csg').then(() => {
    const btn = copyBoosterWallet;
    const original = btn.innerHTML;
    btn.innerHTML = 'Copied!';
    setTimeout(() => btn.innerHTML = original, 2000);
  });
});
copyReceipt.addEventListener('click', () => {
  navigator.clipboard.writeText(receiptContent.textContent).then(() => {
    const btn = copyReceipt;
    const original = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-copy mr-2"></i> Copied!';
    setTimeout(() => btn.innerHTML = '<i class="fas fa-copy mr-2"></i> Copy', 2000);
  });
});
printReceipt.addEventListener('click', () => {
  const printWindow = window.open('', '', 'height=600,width=800');
  printWindow.document.write('<html><head><title>Receipt</title>');
  printWindow.document.write('</head><body >');
  printWindow.document.write(receiptContent.textContent.replace(/\n/g, '<br>'));
  printWindow.document.write('</body></html>');
  printWindow.document.close();
  printWindow.focus();
  printWindow.print();
});
function loadAdminPanel() {
  const users = getAllUsers();
  const allTransactions = getAllTransactions();
  const pendingTx = allTransactions.filter(tx => tx.status === 'pending');
  adminTotalUsers.textContent = users.length;
  const totalBalance = users.reduce((sum, u) => sum + (u.balance || 0), 0);
  adminTotalBalance.textContent = `${formatUGX(totalBalance)} UGX`;
  adminPendingRequests.textContent = pendingTx.length;
  const activeBoosters = users.filter(u =>
    u.pendingBoosterTxId &&
    (u.transactions || []).find(t => t.id === u.pendingBoosterTxId)?.status === 'approved'
  ).length;
  adminActiveBoosters.textContent = activeBoosters;
  renderTransactionTable(allTransactions);
  renderUserTable(users);
  renderBalanceChart(users);
  renderTxTypeChart(allTransactions);
}
function renderTransactionTable(transactions) {
  const filtered = transactions.filter(tx => {
    const search = adminSearch.value.toLowerCase();
    const type = adminFilter.value;
    const matchesSearch = !search || 
      tx.username.toLowerCase().includes(search) || 
      tx.id?.toLowerCase().includes(search) ||
      tx.wallet?.toLowerCase().includes(search);
    const matchesType = type === 'all' || tx.type === type;
    return matchesSearch && matchesType;
  });
  adminTxTableBody.innerHTML = filtered.length ? filtered.map(tx => `
    <tr class="border-b border-gray-700 hover:bg-gray-700/30">
      <td class="py-2">${tx.username}</td>
      <td class="py-2 font-mono text-sm">${tx.wallet || 'N/A'}</td>
      <td class="py-2">${tx.type}</td>
      <td class="py-2">${tx.amount ? formatUGX(tx.amount) + ' UGX' : 'N/A'}</td>
      <td class="py-2">
        <span class="status-pending">${tx.status}</span>
      </td>
      <td class="py-2 text-sm">${new Date(tx.timestamp).toLocaleString()}</td>
      <td class="py-2">
        ${tx.status === 'pending' ? `
          <button onclick="approveRequest('${tx.username}', '${tx.id}')" class="text-green-400 text-xs mr-2">Approve</button>
          <button onclick="rejectRequest('${tx.username}', '${tx.id}')" class="text-red-400 text-xs">Reject</button>
        ` : '<span class="text-gray-500 text-xs">Resolved</span>'}
      </td>
    </tr>
  `).join('') : '<tr><td colspan="7" class="text-center py-4 text-gray-500">No transactions found</td></tr>';
  window.approveRequest = (username, txId) => {
    const user = getUser(username);
    if (!user) return;
    const tx = user.transactions.find(t => t.id === txId);
    if (!tx) return;
    tx.status = 'approved';
    if (tx.type === 'Withdrawal Request') {
      user.balance = 0;
      user.miningCycleHours = 24;
      user.pendingBooster = null;
      user.pendingBoosterTxId = null;
      user.nextClaimTime = Date.now() + 24 * 60 * 60 * 1000;
      user.lastWithdrawalApproved = Date.now();
      alert(`Withdrawal approved for ${username}. Balance reset.`);
    } else if (tx.type === 'Booster Payment') {
      alert(`Booster approved for ${username}.`);
    }
    saveUser(username, user);
    loadAdminPanel();
    if (appState.currentUser === username) {
      login(username, user.password);
    }
  };
  window.rejectRequest = (username, txId) => {
    const user = getUser(username);
    if (!user) return;
    const tx = user.transactions.find(t => t.id === txId);
    if (!tx) return;
    tx.status = 'rejected';
    saveUser(username, user);
    loadAdminPanel();
    if (appState.currentUser === username) {
      login(username, user.password);
    }
    alert(`Rejected request for ${username}`);
  };
}
function renderUserTable(users) {
  adminUserTableBody.innerHTML = users.length ? users.map(user => `
    <tr class="border-b border-gray-700 hover:bg-gray-700/30">
      <td class="py-2">${user.username}</td>
      <td class="py-2">${user.userEmail || 'N/A'}</td>
      <td class="py-2">${formatUGX(user.balance || 0)} UGX</td>
      <td class="py-2 font-mono text-sm">${user.userWallet || 'Not set'}</td>
      <td class="py-2">${user.miningCycleHours || 24} hours</td>
    </tr>
  `).join('') : '<tr><td colspan="5" class="text-center py-4 text-gray-500">No users found</td></tr>';
}
function renderBalanceChart(users) {
  const ctx = document.getElementById('balanceChart').getContext('2d');
  if (balanceChart) balanceChart.destroy();
  const data = users.map(u => u.balance || 0);
  balanceChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: users.map(u => u.username),
      datasets: [{
        label: 'Balance (UGX)',
        data: data,
        backgroundColor: '#00c16a',
        borderColor: '#00a870',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { beginAtZero: true, ticks: { color: '#94a3b8' } },
        x: { ticks: { color: '#94a3b8' } }
      },
      plugins: { legend: { labels: { color: '#f1f5f9' } } }
    }
  });
}
function renderTxTypeChart(transactions) {
  const types = ['Booster Payment', 'Withdrawal Request'];
  const counts = types.map(type => 
    transactions.filter(tx => tx.type === type).length
  );
  const ctx = document.getElementById('txTypeChart').getContext('2d');
  if (txTypeChart) txTypeChart.destroy();
  txTypeChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: types,
      datasets: [{
        data: counts,
        backgroundColor: ['#00c16a', '#f59e0b'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { labels: { color: '#f1f5f9' } }
      }
    }
  });
}
adminSearch.addEventListener('input', () => loadAdminPanel());
adminFilter.addEventListener('change', () => loadAdminPanel());

// === INIT ===
function initApp() {
  const savedUser = localStorage.getItem('ugx_current_user');
  if (savedUser) {
    const user = getUser(savedUser);
    if (user) {
      login(savedUser, user.password);
      return;
    }
  }
  authCard.classList.remove('hidden');
  updateAuthButton();
}
initApp();
});
</script>
</div>
</body>
</html>
