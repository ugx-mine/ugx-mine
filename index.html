<script>
document.addEventListener('DOMContentLoaded', async () => {
  // === SUPABASE SETUP ===
  const { createClient } = window.supabase;
  const supabase = createClient(
    'https://rryvibgbpqyumfmgsiua.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyeXZpYmdicHF5dW1mbWdzaXVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4OTUwNTUsImV4cCI6MjA4MjQ3MTA1NX0.IMqZtMEiPyMwb8AW1gyFao9Yz2qWgMDibfbpVWOeG8o'
  );

  // === CONFIG ===
  const ADMIN_USER = 'asutex2020';
  const ADMIN_PASS = 'Asu12@ada24';

  // === DOM ELEMENTS ===
  const authCard = document.getElementById('authCard');
  const authToggle = document.getElementById('authToggle');
  const signupForm = document.getElementById('signupForm');
  const loginForm = document.getElementById('loginForm');
  const mainContent = document.getElementById('mainContent');
  const adminPanelBtn = document.getElementById('adminPanelBtn');

  let appState = {
    isAuthenticated: false,
    currentUser: null,
    balance: 0,
    miningReward: 10000,
    miningCycleHours: 24,
    nextClaimTime: 0,
    pendingBoosterTxId: null,
    pendingBooster: null,
    transactions: [],
    userWallet: "",
    userEmail: "",
    userId: ""
  };

  // === SUPABASE FUNCTIONS ===
  async function saveUserToDB(userData) {
    const { error } = await supabase.from('users').upsert(userData, { onConflict: 'username' });
    if (error) {
      console.error('Save error:', error);
      alert('Failed to save user. Check console.');
    }
  }

  async function getUserFromDB(username) {
    const { data, error } = await supabase.from('users').select('*').eq('username', username).single();
    if (error && error.code !== 'PGRST116') {
      console.error('Fetch error:', error);
    }
    return data;
  }

  // === SIGN UP ===
  signupForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = document.getElementById('signupUsername').value.trim();
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value;

    if (!username || !email || !password) {
      alert('All fields required');
      return;
    }

    const existing = await getUserFromDB(username);
    if (existing) {
      alert('Username already exists');
      return;
    }

    const newUser = {
      username,
      password,
      user_email: email,
      balance: 0,
      mining_reward: 10000,
      mining_cycle_hours: 24,
      next_claim_time: null,
      pending_booster_tx_id: null,
      pending_booster: null,
      transactions: [],
      user_wallet: "",
      user_id: `UGX-${Math.floor(100000 + Math.random() * 900000)}`
    };

    await saveUserToDB(newUser);
    await login(username, password);
  });

  // === LOGIN ===
  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    await login(username, password);
  });

  async function login(username, password) {
    // Admin
    if (username === ADMIN_USER && password === ADMIN_PASS) {
      appState = {
        isAuthenticated: true,
        currentUser: ADMIN_USER,
        balance: 0,
        miningReward: 10000,
        miningCycleHours: 24,
        nextClaimTime: 0,
        pendingBoosterTxId: null,
        pendingBooster: null,
        transactions: [],
        userWallet: "",
        userEmail: "admin@ugxmine.com",
        userId: "ADMIN"
      };
      afterLogin();
      return;
    }

    // Regular user
    const user = await getUserFromDB(username);
    if (!user) {
      alert('User not found'); // â† This is what you're seeing
      return;
    }
    if (user.password !== password) {
      alert('Incorrect password');
      return;
    }

    // Load user into state
    appState = {
      isAuthenticated: true,
      currentUser: username,
      balance: parseFloat(user.balance) || 0,
      miningReward: parseFloat(user.mining_reward) || 10000,
      miningCycleHours: parseFloat(user.mining_cycle_hours) || 24,
      nextClaimTime: user.next_claim_time ? new Date(user.next_claim_time).getTime() : 0,
      pendingBoosterTxId: user.pending_booster_tx_id || null,
      pendingBooster: user.pending_booster ? parseFloat(user.pending_booster) : null,
      transactions: Array.isArray(user.transactions) ? user.transactions : [],
      userWallet: user.user_wallet || "",
      userEmail: user.user_email || "",
      userId: user.user_id || `UGX-${Math.floor(100000 + Math.random() * 900000)}`
    };

    afterLogin();
  }

  function afterLogin() {
    authCard.classList.add('hidden');
    mainContent.classList.remove('hidden');
    localStorage.setItem('ugx_current_user', appState.currentUser); // for auto-login
    authToggle.textContent = 'Logout';
    authToggle.className = 'px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg';
    adminPanelBtn.classList.toggle('hidden', appState.currentUser !== ADMIN_USER);
    // You can add updateUI() here later
    alert(`Welcome, ${appState.currentUser}!`);
  }

  // === LOGOUT ===
  authToggle.addEventListener('click', () => {
    if (appState.isAuthenticated) {
      appState = { isAuthenticated: false, currentUser: null };
      localStorage.removeItem('ugx_current_user');
      mainContent.classList.add('hidden');
      authCard.classList.remove('hidden');
      authToggle.textContent = 'Sign Up / Login';
      authToggle.className = 'px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg';
    } else {
      authCard.classList.remove('hidden');
    }
  });

  // === INIT ===
  const savedUser = localStorage.getItem('ugx_current_user');
  if (savedUser) {
    const user = await getUserFromDB(savedUser);
    if (user) {
      await login(savedUser, user.password);
      return;
    }
  }
  authCard.classList.remove('hidden');
});
</script>
