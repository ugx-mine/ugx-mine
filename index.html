<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UGX Mining Platform</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- ✅ SUPABASE SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* Your exact CSS — preserved */
.mining-card {
background: linear-gradient(135deg, #0f172a 0%, #121a2e 100%);
border: 1px solid #2a3d6a;
border-radius: 16px;
padding: 1.5rem;
margin-bottom: 1.5rem;
}
/* ... rest of your CSS ... */
</style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen font-sans">
<div class="container mx-auto px-4 py-6">

<!-- ✅ YOUR ORIGINAL HTML STRUCTURE — preserved exactly -->
<header class="flex justify-between items-center mb-8">
<div class="flex items-center space-x-3">
<div class="bg-green-500 p-2 rounded-lg">
<i class="fas fa-coins text-xl"></i>
</div>
<h1 class="text-2xl font-bold">UGX<span class="text-white">Mine</span></h1>
</div>
<div class="flex gap-2">
<button id="adminPanelBtn" class="px-3 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm hidden">
Admin Panel
</button>
<button id="authToggle" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg">
Sign Up / Login
</button>
</div>
</header>

<!-- Auth Card -->
<div id="authCard" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center hidden">
<div class="bg-gray-800 rounded-xl p-6 w-full max-w-md">
<div class="flex mb-4 bg-gray-700 rounded-lg p-1">
<div id="tabSignup" class="auth-tab active">Sign Up</div>
<div id="tabLogin" class="auth-tab">Login</div>
</div>
<form id="signupForm" class="hidden">
<div class="mb-4">
<label class="block text-gray-300 mb-2">Username</label>
<input type="text" id="signupUsername" class="w-full bg-gray-700 rounded-lg px-4 py-2" required>
</div>
<div class="mb-4">
<label class="block text-gray-300 mb-2">Email</label>
<input type="email" id="signupEmail" class="w-full bg-gray-700 rounded-lg px-4 py-2" required>
</div>
<div class="mb-4">
<label class="block text-gray-300 mb-2">Password</label>
<input type="password" id="signupPassword" class="w-full bg-gray-700 rounded-lg px-4 py-2" required>
</div>
<button type="submit" class="w-full bg-green-600 hover:bg-green-700 py-2 rounded-lg">
Create Account
</button>
</form>
<form id="loginForm">
<div class="mb-4">
<label class="block text-gray-300 mb-2">Username</label>
<input type="text" id="loginUsername" class="w-full bg-gray-700 rounded-lg px-4 py-2" required>
</div>
<div class="mb-4">
<label class="block text-gray-300 mb-2">Password</label>
<input type="password" id="loginPassword" class="w-full bg-gray-700 rounded-lg px-4 py-2" required>
</div>
<button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 py-2 rounded-lg">
Login
</button>
</form>
<button id="closeAuth" class="w-full mt-4 bg-gray-700 hover:bg-gray-600 py-2 rounded-lg">
Cancel
</button>
</div>
</div>

<!-- Main Content (hidden until login) -->
<main id="mainContent" class="hidden">
<!-- Your full dashboard HTML — mining cards, boosters, transaction list, etc. -->
<div class="mining-card mb-6">
<div class="flex flex-wrap items-center justify-between gap-4">
<div class="flex items-center space-x-4">
<div class="w-12 h-12 rounded-full bg-emerald-900/30 flex items-center justify-center">
<i class="fas fa-user text-emerald-400"></i>
</div>
<div>
<div class="font-bold text-lg" id="profileUserName">User</div>
<div class="text-gray-400 text-sm" id="profileUserEmail">email@example.com</div>
<div class="text-gray-500 text-xs mt-1" id="profileUserId">User ID: ...</div>
</div>
</div>
<button id="editProfileBtn" class="edit-profile-btn">
<i class="fas fa-edit"></i> Wallet
</button>
</div>
</div>
<div class="mining-card mb-6">
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
<div>
<p class="text-gray-400 text-sm">Current Balance</p>
<p class="text-3xl font-bold currency-display" id="balanceUGX">0 UGX</p>
</div>
<!-- ... rest of your UI ... -->
</div>
</div>
<!-- Include ALL your original HTML here -->
</main>

<!-- Modals, Admin Panel — include all your original code -->

<!-- ✅ SUPABASE SCRIPT — FULLY INTEGRATED -->
<script>
document.addEventListener('DOMContentLoaded', async () => {
  // === SUPABASE ===
  const { createClient } = window.supabase;
  const supabase = createClient(
    'https://rryvibgbpqyumfmgsiua.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyeXZpYmdicHF5dW1mbWdzaXVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4OTUwNTUsImV4cCI6MjA4MjQ3MTA1NX0.IMqZtMEiPyMwb8AW1gyFao9Yz2qWgMDibfbpVWOeG8o'
  );

  // === CONFIG ===
  const ADMIN_USER = 'asutex2020';
  const ADMIN_PASS = 'Asu12@ada24';

  // === DOM REFERENCES ===
  const authCard = document.getElementById('authCard');
  const mainContent = document.getElementById('mainContent');
  const authToggle = document.getElementById('authToggle');
  const adminPanelBtn = document.getElementById('adminPanelBtn');
  const signupForm = document.getElementById('signupForm');
  const loginForm = document.getElementById('loginForm');
  const tabSignup = document.getElementById('tabSignup');
  const tabLogin = document.getElementById('tabLogin');
  const closeAuth = document.getElementById('closeAuth');
  const profileUserName = document.getElementById('profileUserName');
  const profileUserEmail = document.getElementById('profileUserEmail');
  const profileUserId = document.getElementById('profileUserId');
  const balanceUGX = document.getElementById('balanceUGX');

  // === STATE ===
  let appState = {
    isAuthenticated: false,
    currentUser: null,
    balance: 0,
    miningReward: 10000,
    miningCycleHours: 24,
    nextClaimTime: 0,
    pendingBoosterTxId: null,
    pendingBooster: null,
    transactions: [],
    userWallet: "",
    userEmail: "",
    userId: ""
  };

  // === TABS ===
  tabSignup.addEventListener('click', () => {
    tabSignup.classList.add('active');
    tabLogin.classList.remove('active');
    signupForm.classList.remove('hidden');
    loginForm.classList.add('hidden');
  });
  tabLogin.addEventListener('click', () => {
    tabLogin.classList.add('active');
    tabSignup.classList.remove('active');
    loginForm.classList.remove('hidden');
    signupForm.classList.add('hidden');
  });

  // === SIGN UP ===
  signupForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = document.getElementById('signupUsername').value.trim();
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value;
    if (!username || !email || !password) return alert('All fields required');

    const { data: existing } = await supabase
      .from('users')
      .select()
      .eq('username', username)
      .single();

    if (existing) return alert('Username already exists');

    const newUser = {
      username,
      password,
      user_email: email,
      balance: 0,
      mining_reward: 10000,
      mining_cycle_hours: 24,
      next_claim_time: null,
      pending_booster_tx_id: null,
      pending_booster: null,
      transactions: [],
      user_wallet: "",
      user_id: `UGX-${Math.floor(100000 + Math.random() * 900000)}`
    };

    const { error } = await supabase.from('users').insert(newUser);
    if (error) {
      console.error('Signup error:', error);
      alert('Failed to create account');
    } else {
      await login(username, password);
    }
  });

  // === LOGIN ===
  loginForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    login(username, password);
  });

  async function login(username, password) {
    // Admin
    if (username === ADMIN_USER && password === ADMIN_PASS) {
      appState = {
        isAuthenticated: true,
        currentUser: ADMIN_USER,
        balance: 0,
        miningReward: 10000,
        miningCycleHours: 24,
        nextClaimTime: 0,
        pendingBoosterTxId: null,
        pendingBooster: null,
        transactions: [],
        userWallet: "",
        userEmail: "admin@ugxmine.com",
        userId: "ADMIN"
      };
      afterLogin();
      return;
    }

    // Regular user
    const { data: user, error } = await supabase
      .from('users')
      .select('*')
      .eq('username', username)
      .eq('password', password)
      .single();

    if (error || !user) {
      alert('User not found or incorrect password');
      return;
    }

    appState = {
      isAuthenticated: true,
      currentUser: username,
      balance: parseFloat(user.balance) || 0,
      miningReward: parseFloat(user.mining_reward) || 10000,
      miningCycleHours: parseFloat(user.mining_cycle_hours) || 24,
      nextClaimTime: user.next_claim_time ? new Date(user.next_claim_time).getTime() : 0,
      pendingBoosterTxId: user.pending_booster_tx_id || null,
      pendingBooster: user.pending_booster ? parseFloat(user.pending_booster) : null,
      transactions: Array.isArray(user.transactions) ? user.transactions : [],
      userWallet: user.user_wallet || "",
      userEmail: user.user_email || "",
      userId: user.user_id || `UGX-${Math.floor(100000 + Math.random() * 900000)}`
    };

    afterLogin();
  }

  function afterLogin() {
    authCard.classList.add('hidden');
    mainContent.classList.remove('hidden');
    localStorage.setItem('ugx_current_user', appState.currentUser);
    authToggle.textContent = 'Logout';
    authToggle.className = 'px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg';
    adminPanelBtn.classList.toggle('hidden', appState.currentUser !== ADMIN_USER);

    // Update UI with user data
    profileUserName.textContent = appState.currentUser;
    profileUserEmail.textContent = appState.userEmail;
    profileUserId.textContent = `User ID: ${appState.userId}`;
    balanceUGX.textContent = `${appState.balance.toLocaleString()} UGX`;

    // You can add your full updateUI() here later
  }

  // === LOGOUT ===
  authToggle.addEventListener('click', () => {
    if (appState.isAuthenticated) {
      appState = { isAuthenticated: false, currentUser: null };
      localStorage.removeItem('ugx_current_user');
      mainContent.classList.add('hidden');
      authCard.classList.remove('hidden');
      authToggle.textContent = 'Sign Up / Login';
      authToggle.className = 'px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg';
    } else {
      authCard.classList.remove('hidden');
    }
  });

  closeAuth.addEventListener('click', () => authCard.classList.add('hidden'));

  // === INIT ===
  const savedUser = localStorage.getItem('ugx_current_user');
  if (savedUser) {
    const { data: user } = await supabase
      .from('users')
      .select('password')
      .eq('username', savedUser)
      .single();
    if (user) {
      await login(savedUser, user.password);
      return;
    }
  }
  authCard.classList.remove('hidden');
});
</script>
</div>
</body>
</html>
