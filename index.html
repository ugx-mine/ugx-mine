<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UGX Mining Platform</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* [Your exact CSS — unchanged] */
.mining-card {
background: linear-gradient(135deg, #0f172a 0%, #121a2e 100%);
border: 1px solid #2a3d6a;
border-radius: 16px;
padding: 1.5rem;
margin-bottom: 1.5rem;
}
.booster-card {
background: linear-gradient(135deg, #1a2642 0%, #121a2e 100%);
border: 1px solid #2a3d6a;
border-radius: 16px;
padding: 1.5rem;
transition: all 0.3s ease;
position: relative;
overflow: hidden;
}
.booster-card::before {
content: '';
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 4px;
background: linear-gradient(90deg, #00c16a, #00a870);
}
.booster-card:hover {
transform: translateY(-5px);
box-shadow: 0 10px 25px rgba(0, 193, 106, 0.2);
border-color: #00c16a;
}
.booster-duration {
background: rgba(0, 193, 106, 0.15);
color: #00c16a;
border: 1px solid rgba(0, 193, 106, 0.3);
padding: 0.1rem 0.5rem;
border-radius: 4px;
font-size: 0.8rem;
font-weight: bold;
}
.countdown-display {
font-family: monospace;
font-size: 1.5rem;
background: rgba(18, 26, 46, 0.7);
padding: 0.5rem 1rem;
border-radius: 0.5rem;
min-width: 180px;
text-align: center;
}
.status-pending {
background-color: rgba(245, 158, 11, 0.15);
color: #f59e0b;
padding: 0.25rem 0.75rem;
border-radius: 9999px;
font-size: 0.75rem;
}
.no-transactions {
text-align: center;
padding: 2rem;
color: #64748b;
}
.currency-display {
font-family: 'Courier New', monospace;
font-weight: 600;
}
.edit-profile-btn {
background: transparent;
border: 1px solid #00c16a;
color: #00c16a;
padding: 0.25rem 0.75rem;
border-radius: 0.375rem;
font-size: 0.875rem;
display: flex;
align-items: center;
gap: 0.25rem;
transition: all 0.2s;
}
.edit-profile-btn:hover {
background: rgba(0, 193, 106, 0.1);
}
.action-buttons-section {
display: flex;
flex-wrap: wrap;
gap: 1rem;
margin-bottom: 2rem;
}
.action-button {
flex: 1;
min-width: 200px;
}
.auth-tab {
padding: 0.5rem 1rem;
cursor: pointer;
border-radius: 0.5rem;
}
.auth-tab.active {
background: rgba(0, 193, 106, 0.2);
color: #00c16a;
}
@keyframes slideIn {
from { transform: translateY(-20px); opacity: 0; }
to { transform: translateY(0); opacity: 1; }
}
#withdrawSuccessBanner {
animation: slideIn 0.3s ease-out;
}
@media (max-width: 768px) {
.action-buttons-section {
flex-direction: column;
}
.grid.grid-cols-1.md\:grid-cols-3 {
grid-template-columns: 1fr !important;
}
}
</style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen font-sans">
<div class="container mx-auto px-4 py-6">
<!-- [Your exact HTML structure — unchanged] -->
<header class="flex justify-between items-center mb-8">
<div class="flex items-center space-x-3">
<div class="bg-green-500 p-2 rounded-lg">
<i class="fas fa-coins text-xl"></i>
</div>
<h1 class="text-2xl font-bold">UGX<span class="text-white">Mine</span></h1>
</div>
<div class="flex gap-2">
<button id="adminPanelBtn" class="px-3 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm hidden">
Admin Panel
</button>
<button id="authToggle" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg">
Sign Up / Login
</button>
</div>
</header>

<!-- Auth Card -->
<div id="authCard" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center hidden">
<!-- ... (entire auth card unchanged) ... -->
</div>

<main id="mainContent" class="hidden">
<!-- ... (entire main UI unchanged) ... -->
</main>

<!-- Enhanced Admin Panel -->
<div id="adminPanel" class="hidden">
<!-- ... (admin UI unchanged) ... -->
</div>

<!-- Modals -->
<div id="withdrawModal" class="fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4 hidden">
<!-- ... -->
</div>
<div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4 hidden">
<!-- ... -->
</div>
<div id="editProfileModal" class="fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4 hidden">
<!-- ... -->
</div>
<div id="receiptModal" class="fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4 hidden">
<!-- ... -->
</div>

<!-- SUPABASE & APP LOGIC -->
<script>
// === SUPABASE CONFIG ===
const SUPABASE_URL = 'https://rryvibgbpqyumfmgsiua.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyeXZpYmdicHF5dW1mbWdzaXVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4OTUwNTUsImV4cCI6MjA4MjQ3MTA1NX0.IMqZtMEiPyMwb8AW1gyFao9Yz2qWgMDibfbpVWOeG8o';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// === ADMIN CREDENTIALS (unchanged) ===
const ADMIN_USER = 'asutex2020';
const ADMIN_PASS = 'Asu12@ada24';

// === SUPABASE USER FUNCTIONS ===
async function saveUser(username, userData) {
  const { error } = await supabase
    .from('users')
    .upsert({ username, ...userData }, { onConflict: 'username' });
  if (error) console.error('Save error:', error);
}

async function getUser(username) {
  const { data, error } = await supabase
    .from('users')
    .select('*')
    .eq('username', username)
    .single();
  if (error && error.code !== 'PGRST116') console.error('Fetch error:', error);
  return data;
}

async function getAllUsers() {
  const { data, error } = await supabase.from('users').select('*');
  if (error) {
    console.error('Fetch all users error:', error);
    return [];
  }
  return data;
}

async function getAllTransactions() {
  const users = await getAllUsers();
  let allTx = [];
  users.forEach(user => {
    const txs = user.transactions || [];
    txs.forEach(tx => allTx.push({ ...tx, username: user.username }));
  });
  return allTx;
}

// === APP STATE (same as before) ===
let appState = {
  isAuthenticated: false,
  currentUser: null,
  balance: 0,
  miningReward: 10000,
  miningCycleHours: 24,
  nextClaimTime: 0,
  pendingBoosterTxId: null,
  pendingBooster: null,
  transactions: [],
  userWallet: "",
  userEmail: "",
  userId: ""
};

// [All your DOM element references — exact same as original]

let countdownInterval = null;

// === LOGIN (Supabase-aware) ===
async function login(username, password) {
  if (username === ADMIN_USER && password === ADMIN_PASS) {
    appState = {
      isAuthenticated: true,
      currentUser: ADMIN_USER,
      balance: 0,
      miningReward: 10000,
      miningCycleHours: 24,
      nextClaimTime: 0,
      pendingBoosterTxId: null,
      pendingBooster: null,
      transactions: [],
      userWallet: "",
      userEmail: "admin@ugxmine.com",
      userId: "ADMIN"
    };
    afterLogin();
    return true;
  }

  const user = await getUser(username);
  if (!user) {
    alert('User not found');
    return false;
  }
  if (user.password !== password) {
    alert('Incorrect password');
    return false;
  }

  // Convert timestamptz to ms
  const nextClaimTime = user.next_claim_time ? new Date(user.next_claim_time).getTime() : 0;
  const lastWithdrawalApproved = user.last_withdrawal_approved ? new Date(user.last_withdrawal_approved).getTime() : null;

  appState = {
    isAuthenticated: true,
    currentUser: username,
    balance: parseFloat(user.balance) || 0,
    miningReward: parseFloat(user.mining_reward) || 10000,
    miningCycleHours: parseFloat(user.mining_cycle_hours) || 24,
    nextClaimTime,
    pendingBoosterTxId: user.pending_booster_tx_id || null,
    pendingBooster: user.pending_booster ? parseFloat(user.pending_booster) : null,
    transactions: Array.isArray(user.transactions) ? user.transactions : [],
    userWallet: user.user_wallet || "",
    userEmail: user.user_email || "",
    userId: user.user_id || `UGX-${Math.floor(100000 + Math.random() * 900000)}`
  };

  // Show success banner if recently approved
  if (lastWithdrawalApproved && (Date.now() - lastWithdrawalApproved < 60000)) {
    setTimeout(() => {
      const banner = document.getElementById('withdrawSuccessBanner');
      if (banner) {
        banner.classList.remove('hidden');
        setTimeout(() => banner.classList.add('hidden'), 5000);
      }
    }, 500);
    // Clear the flag
    await saveUser(username, { last_withdrawal_approved: null });
  }

  afterLogin();
  return true;
}

// === SAVE STATE TO SUPABASE ===
async function saveState() {
  if (appState.currentUser === ADMIN_USER) return;

  const user = {
    balance: appState.balance,
    mining_reward: appState.miningReward,
    mining_cycle_hours: appState.miningCycleHours,
    next_claim_time: appState.nextClaimTime ? new Date(appState.nextClaimTime).toISOString() : null,
    pending_booster_tx_id: appState.pendingBoosterTxId,
    pending_booster: appState.pendingBooster,
    transactions: appState.transactions,
    user_wallet: appState.userWallet,
    user_email: appState.userEmail,
    user_id: appState.userId
  };
  await saveUser(appState.currentUser, user);
}

// === INIT ===
async function initApp() {
  const savedUser = localStorage.getItem('ugx_current_user');
  if (savedUser) {
    const user = await getUser(savedUser);
    if (user) {
      // Reuse stored password (for seamless reload)
      if (await login(savedUser, user.password)) return;
    }
  }
  document.getElementById('authCard').classList.remove('hidden');
  updateAuthButton();
}

// [All your UI/update/claim/modal functions — logic identical, only saveState() changed]

function afterLogin() {
  document.getElementById('authCard').classList.add('hidden');
  document.getElementById('mainContent').classList.remove('hidden');
  localStorage.setItem('ugx_current_user', appState.currentUser);
  updateAuthButton();
  document.getElementById('adminPanelBtn').classList.toggle('hidden', appState.currentUser !== ADMIN_USER);
  updateUI();
  if (appState.nextClaimTime > 0 && Date.now() < appState.nextClaimTime) {
    startCountdown();
  }
}

function updateAuthButton() {
  const btn = document.getElementById('authToggle');
  if (appState.isAuthenticated) {
    btn.textContent = 'Logout';
    btn.className = 'px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg';
  } else {
    btn.textContent = 'Sign Up / Login';
    btn.className = 'px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg';
  }
}

// === Override claimReward to use Supabase ===
function claimReward() {
  appState.balance += appState.miningReward;
  if (appState.pendingBoosterTxId) {
    const tx = appState.transactions.find(t => t.id === appState.pendingBoosterTxId);
    if (tx && tx.status === 'approved') {
      appState.miningCycleHours = appState.pendingBooster;
      appState.pendingBooster = null;
      appState.pendingBoosterTxId = null;
    }
  }
  const cycleMs = appState.miningCycleHours * 60 * 60 * 1000;
  appState.nextClaimTime = Date.now() + cycleMs;
  saveState(); // ← Now saves to Supabase
  updateUI();
  startCountdown();
  alert(`Claimed ${formatUGX(appState.miningReward)} UGX!`);
}

// [All modal handlers — e.g., confirmWithdraw, confirmPayment — call saveState() which now uses Supabase]

// === ADMIN PANEL: Fetch from Supabase ===
async function loadAdminPanel() {
  const users = await getAllUsers();
  const allTransactions = await getAllTransactions();
  const pendingTx = allTransactions.filter(tx => tx.status === 'pending');

  // Update stats
  document.getElementById('adminTotalUsers').textContent = users.length;
  const totalBalance = users.reduce((sum, u) => sum + (parseFloat(u.balance) || 0), 0);
  document.getElementById('adminTotalBalance').textContent = `${formatUGX(totalBalance)} UGX`;
  document.getElementById('adminPendingRequests').textContent = pendingTx.length;
  const activeBoosters = users.filter(u =>
    u.pending_booster_tx_id && Array.isArray(u.transactions) &&
    u.transactions.find(t => t.id === u.pending_booster_tx_id)?.status === 'approved'
  ).length;
  document.getElementById('adminActiveBoosters').textContent = activeBoosters;

  // Render tables & charts (same logic)
  renderTransactionTable(allTransactions);
  renderUserTable(users);
  renderBalanceChart(users);
  renderTxTypeChart(allTransactions);
}

// === Override approveRequest to update Supabase ===
async function approveRequest(username, txId) {
  const user = await getUser(username);
  if (!user || !Array.isArray(user.transactions)) return;

  const tx = user.transactions.find(t => t.id === txId);
  if (!tx) return;

  const updatedTxs = user.transactions.map(t =>
    t.id === txId ? { ...t, status: 'approved' } : t
  );

  let updateData = { transactions: updatedTxs };

  if (tx.type === 'Withdrawal Request') {
    updateData = {
      ...updateData,
      balance: 0,
      mining_cycle_hours: 24,
      pending_booster: null,
      pending_booster_tx_id: null,
      next_claim_time: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
      last_withdrawal_approved: new Date().toISOString()
    };
    alert(`Withdrawal approved for ${username}. Balance reset.`);
  } else if (tx.type === 'Booster Payment') {
    alert(`Booster approved for ${username}.`);
  }

  await saveUser(username, updateData);

  if (appState.currentUser === username) {
    // Refresh user session
    await login(username, user.password);
  }

  loadAdminPanel();
}

// Similarly for rejectRequest
async function rejectRequest(username, txId) {
  const user = await getUser(username);
  if (!user || !Array.isArray(user.transactions)) return;
  const updatedTxs = user.transactions.map(tx =>
    tx.id === txId ? { ...tx, status: 'rejected' } : tx
  );
  await saveUser(username, { transactions: updatedTxs });
  if (appState.currentUser === username) {
    await login(username, user.password);
  }
  alert(`Rejected request for ${username}`);
  loadAdminPanel();
}

// [Include ALL other helper functions exactly as in original: formatUGX, toUSDT, modals, countdown, charts, etc.]

// DOMContentLoaded
document.addEventListener('DOMContentLoaded', initApp);
</script>
</div>
</body>
</html>
