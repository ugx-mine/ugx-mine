<script>
    // === CONFIG ===
    const SUPABASE_URL = 'https://rryvibgbpqyumfmgsiua.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyeXZpYmdicHF5dW1mbWdzaXVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4OTUwNTUsImV4cCI6MjA4MjQ3MTA1NX0.IMqZtMEiPyMwb8AW1gyFao9Yz2qWgMDibfbpVWOeG8o';
    const ADMIN_USER = 'asutex2020';
    const ADMIN_PASS = 'Asu12@ada24';

    const { createClient } = supabase;
    const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let appState = {};
    let timerInterval;

    // --- AUTHENTICATION ---
    async function handleSignup(e) {
        e.preventDefault();
        const u = document.getElementById('signupUsername').value;
        const em = document.getElementById('signupEmail').value;
        const p = document.getElementById('signupPassword').value;

        const { data: exists } = await _supabase.from('users').select('username').eq('username', u).maybeSingle();
        if (exists) return alert("Username exists!");

        const { error } = await _supabase.from('users').insert([{
            username: u, password: p, user_email: em, balance: 0, 
            mining_reward: 10000, mining_cycle_hours: 24, 
            next_claim_time: new Date().toISOString(),
            user_id: 'UGX' + Math.floor(Math.random()*1000000),
            transactions: []
        }]);

        if (error) alert(error.message);
        else { alert("Success! Please Login."); document.getElementById('tabLogin').click(); }
    }

    async function handleLogin(e) {
        e.preventDefault();
        const u = document.getElementById('loginUsername').value;
        const p = document.getElementById('loginPassword').value;

        if (u === ADMIN_USER && p === ADMIN_PASS) {
            document.getElementById('authCard').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
            return;
        }

        const { data, error } = await _supabase.from('users').select('*').eq('username', u).eq('password', p).maybeSingle();
        if (error || !data) return alert("Invalid Login");

        appState = { ...data, nextClaimTime: new Date(data.next_claim_time).getTime() };
        localStorage.setItem('ugx_u', u); localStorage.setItem('ugx_p', p);
        showDashboard();
    }

    // --- CORE MINING ENGINE ---
    async function claimReward() {
        if (Date.now() < appState.nextClaimTime) return alert("Mining still in progress!");

        const newBalance = Number(appState.balance) + Number(appState.mining_reward);
        const newClaimDate = new Date(Date.now() + (appState.mining_cycle_hours * 3600000)).toISOString();

        const { error } = await _supabase.from('users').update({ 
            balance: newBalance, next_claim_time: newClaimDate 
        }).eq('username', appState.username);

        if (error) return alert(error.message);

        appState.balance = newBalance;
        appState.nextClaimTime = new Date(newClaimDate).getTime();
        updateUI();
        startCountdown();
        alert("Success! Reward Claimed.");
    }

    // --- BOOSTERS ---
    async function activateBooster(hours, label) {
        if (!confirm(`Activate ${label} Booster? This will change your mining cycle to ${hours} hours.`)) return;

        const { error } = await _supabase.from('users').update({ 
            mining_cycle_hours: hours 
        }).eq('username', appState.username);

        if (error) return alert(error.message);
        
        appState.mining_cycle_hours = hours;
        alert(`${label} Activated! Your next cycle will be shorter.`);
        location.reload(); // Refresh to apply new cycle
    }

    // --- WITHDRAWALS & WALLET ---
    async function requestWithdrawal() {
        if (!appState.user_wallet || appState.user_wallet === "") {
            return alert("Please set your TRC20 wallet address first!");
        }
        if (appState.balance < 50000) {
            return alert("Minimum withdrawal is 50,000 UGX");
        }

        const amount = appState.balance;
        const newTx = { type: 'Withdrawal', amount: amount, status: 'pending', date: new Date().toISOString() };
        const updatedTxs = [...(appState.transactions || []), newTx];

        const { error } = await _supabase.from('users').update({ 
            balance: 0, 
            transactions: updatedTxs 
        }).eq('username', appState.username);

        if (error) return alert(error.message);
        
        appState.balance = 0;
        appState.transactions = updatedTxs;
        updateUI();
        alert("Withdrawal Request Sent! 20% Fee will be deducted during processing.");
    }

    async function saveWallet() {
        const addr = document.getElementById('userWalletInput').value;
        if (!addr.startsWith('T')) return alert("Invalid TRC20 Address!");

        const { error } = await _supabase.from('users').update({ user_wallet: addr }).eq('username', appState.username);
        if (error) return alert(error.message);

        appState.user_wallet = addr;
        document.getElementById('editProfileModal').classList.add('hidden');
        alert("Wallet Saved!");
    }

    // --- UI UPDATES ---
    function showDashboard() {
        document.getElementById('authCard').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
        document.getElementById('profileUserName').textContent = appState.username;
        document.getElementById('profileUserEmail').textContent = appState.user_email;
        document.getElementById('profileUserId').textContent = "ID: " + appState.user_id;
        document.getElementById('miningCycle').textContent = appState.mining_cycle_hours + " hours";
        updateUI();
        startCountdown();
    }

    function updateUI() {
        document.getElementById('balanceUGX').textContent = Number(appState.balance).toLocaleString() + " UGX";
        document.getElementById('balanceUSDT').textContent = "(~" + (appState.balance/3700).toFixed(2) + " USDT)";
        
        const list = document.getElementById('transactionList');
        if (appState.transactions && appState.transactions.length > 0) {
            list.innerHTML = appState.transactions.map(tx => `
                <div class="flex justify-between border-b border-gray-800 py-2 text-sm">
                    <span>${tx.type} (${Number(tx.amount).toLocaleString()})</span>
                    <span class="${tx.status === 'pending' ? 'text-amber-500' : 'text-green-500'}">${tx.status}</span>
                </div>
            `).join('');
        }
    }

    function startCountdown() {
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            const diff = appState.nextClaimTime - Date.now();
            if (diff <= 0) {
                document.getElementById('miningCountdown').textContent = "Ready!";
                document.getElementById('claimCountdown').textContent = "Ready!";
                return clearInterval(timerInterval);
            }
            const h = Math.floor(diff/3600000).toString().padStart(2,'0');
            const m = Math.floor((diff%3600000)/60000).toString().padStart(2,'0');
            const s = Math.floor((diff%60000)/1000).toString().padStart(2,'0');
            document.getElementById('miningCountdown').textContent = `${h}:${m}:${s}`;
        }, 1000);
    }

    // --- LISTENERS ---
    document.getElementById('signupForm').onsubmit = handleSignup;
    document.getElementById('loginForm').onsubmit = handleLogin;
    document.getElementById('miningBtn').onclick = claimReward;
    document.getElementById('withdrawBtn').onclick = requestWithdrawal;
    document.getElementById('saveProfile').onclick = saveWallet;
    
    // Booster Buttons
    document.getElementById('buyBooster1').onclick = () => activateBooster(8, 'Speed');
    document.getElementById('buyBooster2').onclick = () => activateBooster(6, 'Power');
    document.getElementById('buyBooster3').onclick = () => activateBooster(4, 'Quantum');

    // UI Toggles
    document.getElementById('editProfileBtn').onclick = () => document.getElementById('editProfileModal').classList.remove('hidden');
    document.getElementById('closeEditProfile').onclick = () => document.getElementById('editProfileModal').classList.add('hidden');
    document.getElementById('tabSignup').onclick = () => { /* ... switch logic ... */ }; // Already handled in previous step
    
    window.onload = () => {
        const u = localStorage.getItem('ugx_u'), p = localStorage.getItem('ugx_p');
        if (u && p) { handleLogin({ preventDefault: () => {}, target: { loginUsername: {value: u}, loginPassword: {value: p} } }); }
        else document.getElementById('authCard').classList.remove('hidden');
    };
</script>
