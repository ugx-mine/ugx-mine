<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    // 2. Database Connection - Configured with your credentials
    const supabaseUrl = 'https://rryvibgbpqyumfmgsiua.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyeXZpYmdicHF5dW1mbWdzaXVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4OTUwNTUsImV4cCI6MjA4MjQ3MTA1NX0.IMqZtMEiPyMwb8AW1gyFao9Yz2qWgMDibfbpVWOeG8o';
    const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // 3. Cloud Load Function (Replaces localStorage.getItem)
    async function getUser(username) {
        console.log(`Fetching ${username} from cloud...`);
        const { data, error } = await _supabase
            .from('ugx_users')
            .select('data')
            .eq('username', username)
            .single();

        if (error && error.code !== 'PGRST116') {
            console.error("Cloud Load Error:", error.message);
            return null;
        }
        return data ? data.data : null;
    }

    // 4. Cloud Save Function (Replaces localStorage.setItem)
    async function saveUser(username, userData) {
        console.log(`Syncing ${username} to cloud...`);
        const { error } = await _supabase
            .from('ugx_users')
            .upsert({ 
                username: username, 
                balance: userData.balance, 
                data: userData 
            }, { onConflict: 'username' });

        if (error) {
            console.error("Cloud Sync Failed:", error.message);
        } else {
            console.log("Cloud Sync Successful!");
        }
    }

    // 5. Updated Claim Reward Function
    async function claimReward() {
        if (!currentUser) {
            alert("Please login first!");
            return;
        }

        const reward = 10000;
        currentUser.balance += reward;
        currentUser.lastClaim = new Date().toISOString();
        
        // Update the screen immediately
        updateDashboard();
        
        // Save to the Cloud Database
        await saveUser(currentUser.username, currentUser);
        
        alert("Success! 10,000 UGX added to your cloud account.");
    }
</script>
